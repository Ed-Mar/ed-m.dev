<!doctype html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=https://ed-m.dev/css/style.css><link rel=stylesheet href=https://ed-m.dev/css/single-page.css><title>User Authentication & Authorzation Progress | 221123</title></head><body><nav class=navBar><ul><a href=/>Ed-M.Dev</a>
<a href=/notes>Notes</a>
<a href=/about>About</a></ul></nav><div class="main container single"><div class=single-page-content-container><div class=single-page-header><h2>User Authentication & Authorzation Progress | 221123</h2><time>Wed, Nov 23, 2022</time><div class=single-page-project><h3><a href=/notes/projects/conduit>Project - Conduit</a></h3></div><div class=tags-container><div class=tag-list-item><a href=/tags/keycloak>Keycloak</a></div><div class=tag-list-item><a href=/tags/rust>Rust</a></div><div class=tag-list-item><a href=/tags/yew>Yew</a></div><div class=tag-list-item><a href=/tags/odic>Odic</a></div><div class=tag-list-item><a href=/tags/golang>Golang</a></div><div class=tag-list-item><a href=/tags/oauth2>Oauth2</a></div><div class=tag-list-item><a href=/tags/jwt>JWT</a></div><div class=tag-list-item><a href=/tags/devblog>Devblog</a></div></div></div><br><div class=single-page-content><h1 id=221123>221123</h1><p><em>_0620</em></p><h1 id=user-authentication>User Authentication</h1><p>So its been a while coming for this and a lot of items leading up to this, but I&rsquo;ve been learning and working towards getting to be able to login with in the conduit project. I wanted to get some things down before I move forward since it has been a while and I feel like I have covered some ground, granted I am not there really yet.</p><p>Where I am at right now. I&rsquo;ve got some micro-services up that do not a lot cause I don&rsquo;t have users. I decided almost a year ago now that I wanted to use an open source <a href=https://en.wikipedia.org/wiki/Identity_management>identity/access manager</a> and serve it myself. I do have that with <a href=https://www.keycloak.org/>keycloak</a> and I have running locally. What I don&rsquo;t have is a frontend(frontend client) nor a way for it to talk with the backend(which I kinda have) . I would like to go over my work on these two item.</p><h2 id=conduit-front-end>Conduit Front End</h2><p>So I was feeling froggy and decided to to explore some more options for the frontend. A few months ago I played with some <a href=https://nextjs.org/>Next.js</a>, <a href=https://deno.land/>Deno</a> and just <a href=https://reactjs.org/>react</a>(I think there are some screenshot on older post). While shopping my options the internet kept hounding me to try <a href=https://www.rust-lang.org/>Rust</a> and I did getting a majority of the way through the <a href=https://doc.rust-lang.org/book/>Rust book</a>.Then trying to combine a need and a want I thought why not use rust as front end which seems really odd at first, but Rust does do <a href=https://webassembly.org/>WebAssembly</a>. Which in theory would allow me potentially move this away from the browser at some point in the future which I think would be preferable. There is a small problem though I really don&rsquo;t know Rust, none the less I pushed on.</p><h3 id=yew-framework>Yew Framework</h3><p>I found a framework that use WASM to make web application called <a href=https://yew.rs/>Yew</a>. It&rsquo;s kinda like react, but rust kinda&mldr; I invested in watching a <a href=https://youtu.be/5PB9UDOIuGk>long tutorial series</a> on the framework. Which gave me a decent idea of how to work with it at the same time growing my confidences in rust. With that tutorial series done and Exploring examples on github I have some idea of how Yew works which can best be described as everything is a component.</p><h3 id=yew-oauth2>Yew-OAuth2</h3><p>Now back to the core idea for this note &ldquo;User Authentication&rdquo;. I say <em>&ldquo;Authentication&rdquo;</em> and <strong>not</strong> <em>&ldquo;User Authentication and Authorization&rdquo;</em> due to that I not really leaning on the OAuth so much. I mean I am little, but I mostly just want user to log with ODIC and check if there login is good(I will get in to this more later).</p><p>The internet found me a crate that would felicitate ODIC and OAuth2 and it came with an example that I am leaning on hard.</p><p>So this is where one my big learning events happened. The user client should not have the SSO/IAM client secret(keycloak client) in it. Since I am trying to make things secure(I know I am going to mess it up, but I am tryin). The idea I was using that I only want apps under my lock and key to be able to use my SSO, but after reading up on it(<a href=https://github.com/ctron/yew-oauth2/pull/3>example</a>). I was wrong and lost a week to this. The protection for the SSO comes from the Web Origins.</p><p>So this is what I have for the frontend.</p><p><img src=https://i.imgur.com/Pe2GHKX.png alt="Login "></p><p>This leads this to this</p><p><img src=https://i.imgur.com/0i0nMGK.png alt="Leads to this"></p><p>Then back to this.</p><p><img src=https://i.imgur.com/wzyjKmu.png alt="enter image description here"></p><p>I know it&rsquo;s not a looker, but I do now have a frontend that uses the SSO while handling the session, refreshing, logout/in.</p><p>So now I need to send that information to the backend. Since the SSO sends a JWT to the frontend I just need to pass that to backend to deal with and understand.</p><p>I created a simple request to send the JWT to the backend in the header of a request. I just function in component that loaded once a login is completed and boom it sends it to conduit backend.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#6ab825;font-weight:700>async</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>fn</span>  <span style=color:#447fcf>send_req</span>(access_token: <span style=color:#24909d>String</span> )<span style=color:#666> </span>-&gt;  <span style=color:#24909d>String</span> {<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>	</span><span style=color:#6ab825;font-weight:700>let</span><span style=color:#666>  </span>yeye<span style=color:#666>  </span>=<span style=color:#666>  </span>Request::new(<span style=color:#ed9d13>&#34;http://localhost:9666/&#34;</span>,);<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>	</span><span style=color:#6ab825;font-weight:700>let</span><span style=color:#666>  </span>resp<span style=color:#666>  </span>=&amp;yeye.method(gloo_net::http::Method::POST)<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>		</span>.header(<span style=color:#ed9d13>&#34;Authentication&#34;</span>,<span style=color:#666> </span>&amp;access_token)<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>		</span>.send()<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>		</span>.<span style=color:#6ab825;font-weight:700>await</span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>		</span>.unwrap();<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>	</span><span style=color:#6ab825;font-weight:700>return</span><span style=color:#666>  </span><span style=color:#24909d>String</span>::from(<span style=color:#24909d>String</span>::from(<span style=color:#ed9d13>&#34;Somthing&#34;</span>));<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666></span>}<span style=color:#666>
</span></span></span></code></pre></div><h2 id=conduit-backend>Conduit Backend</h2><p>In backend i have created a new test/dev service using the same pattern I use for the rest of them.</p><p>I did have to add some extra CORS item to deal with sending JWT in the header to the backend. This did take some experimentation to get working.</p><p>I was getting pre-flight errors on the frontend due to CORS so i needed to added some things to header to allow for. In looking into this I learn that these thing are just added to the response header that checked in the pre-flight(ie &ldquo;&ldquo;Access-Control-Allow-Origin&rdquo;, &ldquo;&ldquo;Access-Control-Allow-Methods&rdquo;) which was something new I learned.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	credentials := gohandlers.<span style=color:#447fcf>AllowCredentials</span>()  
</span></span><span style=display:flex><span>	origins := gohandlers.<span style=color:#447fcf>AllowedOrigins</span>([]<span style=color:#6ab825;font-weight:700>string</span>{<span style=color:#ed9d13>&#34;http://localhost:8080&#34;</span>})  
</span></span><span style=display:flex><span>	headers := gohandlers.<span style=color:#447fcf>AllowedHeaders</span>([]<span style=color:#6ab825;font-weight:700>string</span>{<span style=color:#ed9d13>&#34;Authentication&#34;</span>})  
</span></span><span style=display:flex><span>	methods := gohandlers.<span style=color:#447fcf>AllowedMethods</span>([]<span style=color:#6ab825;font-weight:700>string</span>{<span style=color:#ed9d13>&#34;GET&#34;</span>, <span style=color:#ed9d13>&#34;HEAD&#34;</span>, <span style=color:#ed9d13>&#34;POST&#34;</span>, <span style=color:#ed9d13>&#34;PUT&#34;</span>, <span style=color:#ed9d13>&#34;OPTIONS&#34;</span>})
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>srv := &amp;http.Server{  
</span></span><span style=display:flex><span>   Addr:         <span style=color:#ed9d13>&#34;:9666&#34;</span>, <span style=color:#999;font-style:italic>// configure the bind address  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>   Handler:      gohandlers.<span style=color:#447fcf>CORS</span>(credentials, methods, origins, headers)(router),
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>Now I have the access-token in the backend. There are few things I can do with it. I have successfully done one them, but the most important one.</p><h3 id=token-introspection>Token Introspection</h3><blockquote><p>The Token Introspection extension defines a mechanism for resource servers to obtain information about access tokens. With this spec, resource servers can check the validity of access tokens, and find out other information such as which user and which scopes are associated with the token. ~ <a href=https://oauth.net/2/token-introspection/>OAuth.net</a></p></blockquote><p>With the token now I need to check the token with the SSO to confirm it came from it and that its still valid which is another HTTP request.</p><p>which is this</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L -X POST <span style=color:#ed9d13>&#39;http://{HOST/IP_ADDRESS}:{PORT}/realms/{REALM}/protocol/openid-connect/token/introspect&#39;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>   -H <span style=color:#ed9d13>&#34;Authorization: Basic base64&lt;CLIENT_ID:CLIENT_SECRET&gt;&#34;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>   -H <span style=color:#ed9d13>&#34;Accept: application/json&#34;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>   -H <span style=color:#ed9d13>&#34;Content-Type: application/x-www-form-urlencoded&#34;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>   --data-urlencode <span style=color:#ed9d13>&#39;token=&lt;ACCESS_TOKEN&gt;&#39;</span> <span style=color:#ed9d13>\
</span></span></span><span style=display:flex><span><span style=color:#ed9d13></span>   | jq
</span></span></code></pre></div><p>Let&rsquo;s break this down.</p><p>Its a POST request with some headers, and json body with the access token in it.</p><p>The destination Keycloak will tell you at its <em>&rdquo;&mldr;/.well-known/openid-configuration&rdquo;</em>
mine locally was &lsquo;http:/ /keycloak.test/realms/gatehouse/protocol/openid-connect/token/introspect&rsquo;</p><p><strong>Authorization</strong> is base64ing the CLIENT_ID:CLIENT_SECRET.
This is where I learned something else that after being suck and just trying it. I made a new SSO Client that was <strong>not public</strong> in the same realm thinking it should have the same access the other client for the frontend being in the same realm and with the same roles.</p><p>To get the base64 of that new client and its secret echo pipe it into base64 and copy paste that into the HTTP request</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#24909d>echo</span> -n <span style=color:#ed9d13>&#39;CLIENT_ID:CLIENT_SECRET&#39;</span> | base64 
</span></span></code></pre></div><p>The other two headers are as they read.</p><p>Then just insert the access token into that CURL to get your introspective if all works well you get something like this. I added some comments to give myself a better understanding</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;exp&#34;</span>: <span style=color:#3677a9>1669201864</span>, <span style=color:#999;font-style:italic>// Expiration time  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;iat&#34;</span>: <span style=color:#3677a9>1669201564</span>, <span style=color:#999;font-style:italic>// Issused at  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;auth_time&#34;</span>: <span style=color:#3677a9>1669201564</span>, <span style=color:#999;font-style:italic>// Time Authentication Happened (All time&#39;s Unix)  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;jti&#34;</span>: <span style=color:#ed9d13>&#34;cc18de55-90d4-4730-b326-2dc64612cd6c&#34;</span>, <span style=color:#999;font-style:italic>//JWT Unique ID  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;iss&#34;</span>: <span style=color:#ed9d13>&#34;http://keycloak.test/realms/gatehouse&#34;</span>, <span style=color:#999;font-style:italic>// Issuer  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;aud&#34;</span>: <span style=color:#ed9d13>&#34;account&#34;</span>, <span style=color:#999;font-style:italic>// Intended Token Audince  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;sub&#34;</span>: <span style=color:#ed9d13>&#34;8b603c06-ee77-4f60-a0bd-72652808b861&#34;</span>, <span style=color:#999;font-style:italic>//Subject ID (UUID) or the users UUID in the  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;typ&#34;</span>: <span style=color:#ed9d13>&#34;Bearer&#34;</span>, <span style=color:#999;font-style:italic>//Token Type  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;azp&#34;</span>: <span style=color:#ed9d13>&#34;dev-conduit-rust&#34;</span>, <span style=color:#999;font-style:italic>//Authorization Party (Client)  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;nonce&#34;</span>: <span style=color:#ed9d13>&#34;Y56MSoeXjA0IxWv1mmWEDA&#34;</span>, <span style=color:#999;font-style:italic>//Unique Value given to Token ID  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;session_state&#34;</span>: <span style=color:#ed9d13>&#34;7597c0bb-28cf-4016-926f-9869d01e2ea9&#34;</span>, <span style=color:#999;font-style:italic>//Unique Value given to Session  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;name&#34;</span>: <span style=color:#ed9d13>&#34;Test User 0000&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;given_name&#34;</span>: <span style=color:#ed9d13>&#34;Test User&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;family_name&#34;</span>: <span style=color:#ed9d13>&#34;0000&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;preferred_username&#34;</span>: <span style=color:#ed9d13>&#34;test-user-0000&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;acr&#34;</span>: <span style=color:#ed9d13>&#34;1&#34;</span>, <span style=color:#999;font-style:italic>//Authencation Context Id  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;allowed-origins&#34;</span>: [ <span style=color:#999;font-style:italic>// Where request can come from( the :9666 isn&#39;t needed)  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#ed9d13>&#34;http://localhost:8080&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;http://localhost:9666&#34;</span>  
</span></span><span style=display:flex><span>  ],  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;realm_access&#34;</span>: {  
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;roles&#34;</span>: [  
</span></span><span style=display:flex><span>      <span style=color:#ed9d13>&#34;offline_access&#34;</span>, <span style=color:#999;font-style:italic>// Still not postive what this its a client role in keyvcloak more information is needed  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#ed9d13>&#34;default-roles-gatehouse&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;uma_authorization&#34;</span>  
</span></span><span style=display:flex><span>  ]  
</span></span><span style=display:flex><span>  },  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;resource_access&#34;</span>: {  
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>&#34;account&#34;</span>: {  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>&#34;roles&#34;</span>: [  
</span></span><span style=display:flex><span>        <span style=color:#ed9d13>&#34;manage-account&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;manage-account-links&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;view-profile&#34;</span>  
</span></span><span style=display:flex><span>  ]  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  },  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;scope&#34;</span>: <span style=color:#ed9d13>&#34;openid microprofile-jwt profile&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;sid&#34;</span>: <span style=color:#ed9d13>&#34;7597c0bb-28cf-4016-926f-9869d01e2ea9&#34;</span>, <span style=color:#999;font-style:italic>//Session ID  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>&#34;upn&#34;</span>: <span style=color:#ed9d13>&#34;test-user-0000&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;groups&#34;</span>: [  
</span></span><span style=display:flex><span>    <span style=color:#ed9d13>&#34;offline_access&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;default-roles-gatehouse&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#ed9d13>&#34;uma_authorization&#34;</span>  
</span></span><span style=display:flex><span>  ],  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;client_id&#34;</span>: <span style=color:#ed9d13>&#34;dev-conduit-rust&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;username&#34;</span>: <span style=color:#ed9d13>&#34;test-user-0000&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#6ab825;font-weight:700>&#34;active&#34;</span>: <span style=color:#6ab825;font-weight:700>true</span> <span style=color:#999;font-style:italic>// The most importatnt part of the introspective Its if the Token is active and good to go  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>}
</span></span></code></pre></div><p>The most import part is the active:true at the bottom that tells me the token is good to go and active.</p><p>Now I just have to convert that into go</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>tokenIntrospect</span>(accessToken *<span style=color:#6ab825;font-weight:700>string</span>) (*http.Response, <span style=color:#6ab825;font-weight:700>error</span>) {  
</span></span><span style=display:flex><span>   introspectURL := <span style=color:#ed9d13>&#34;http://keycloak.test/realms/gatehouse/protocol/openid-connect/token/introspect&#34;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#999;font-style:italic>//Getting the AccessToken into JSON 
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>type</span> Payload <span style=color:#6ab825;font-weight:700>struct</span> {  
</span></span><span style=display:flex><span>      Token <span style=color:#6ab825;font-weight:700>string</span> <span style=color:#ed9d13>`json:&#34;token&#34;`</span>  
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>   formData := &amp;Payload{  
</span></span><span style=display:flex><span>      Token: *accessToken,  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>  <span style=color:#999;font-style:italic>// Getting the Toke to URL Values
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>   payload := url.Values{  
</span></span><span style=display:flex><span>      <span style=color:#ed9d13>&#34;token&#34;</span>: {formData.Token},  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>   req, err := http.<span style=color:#447fcf>NewRequest</span>(<span style=color:#ed9d13>&#34;POST&#34;</span>, introspectURL, strings.<span style=color:#447fcf>NewReader</span>(payload.<span style=color:#447fcf>Encode</span>()))  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>if</span> err != <span style=color:#6ab825;font-weight:700>nil</span> {  
</span></span><span style=display:flex><span>      log.<span style=color:#447fcf>Printf</span>(<span style=color:#ed9d13>&#34;[ERROR] Request Generator failed: %#v&#34;</span>, err)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> &amp;http.Response{}, err  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>   req.Header.<span style=color:#447fcf>Add</span>(<span style=color:#ed9d13>&#34;Authorization&#34;</span>, <span style=color:#ed9d13>&#34;Basic ZGV[REDACTED]==&#34;</span>)  
</span></span><span style=display:flex><span>   req.Header.<span style=color:#447fcf>Set</span>(<span style=color:#ed9d13>&#34;Accept-Encoding&#34;</span>, <span style=color:#ed9d13>&#34;application/json&#34;</span>)  
</span></span><span style=display:flex><span>   req.Header.<span style=color:#447fcf>Add</span>(<span style=color:#ed9d13>&#34;Content-Type&#34;</span>, <span style=color:#ed9d13>&#34;application/x-www-form-urlencoded&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#999;font-style:italic>// Not postive if this still needed,  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>   req.Header.<span style=color:#447fcf>Add</span>(<span style=color:#ed9d13>&#34;Content-Length&#34;</span>, strconv.<span style=color:#447fcf>Itoa</span>(<span style=color:#24909d>len</span>(payload.<span style=color:#447fcf>Encode</span>())))  
</span></span><span style=display:flex><span>   client := &amp;http.Client{  
</span></span><span style=display:flex><span>      Timeout: time.Second * <span style=color:#3677a9>11</span>,  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#999;font-style:italic>// Sending the request for the introspective.  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  res, err := client.<span style=color:#447fcf>Do</span>(req)  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>if</span> err != <span style=color:#6ab825;font-weight:700>nil</span> {  
</span></span><span style=display:flex><span>      log.<span style=color:#447fcf>Printf</span>(<span style=color:#ed9d13>&#34;[ERROR] Sending Token Introspect Request: %#v&#34;</span>, err)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> &amp;http.Response{}, err  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>defer</span> <span style=color:#6ab825;font-weight:700>func</span>(Body io.ReadCloser) {  
</span></span><span style=display:flex><span>      err := Body.<span style=color:#447fcf>Close</span>()  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>if</span> err != <span style=color:#6ab825;font-weight:700>nil</span> {  
</span></span><span style=display:flex><span>         log.<span style=color:#447fcf>Printf</span>(<span style=color:#ed9d13>&#34;[ERROR] Closing Body?!? %#v&#34;</span>, err)  
</span></span><span style=display:flex><span>      }  
</span></span><span style=display:flex><span>   }(res.Body)     
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>return</span> res, <span style=color:#6ab825;font-weight:700>nil</span>
</span></span></code></pre></div><p><img src=https://i.imgur.com/ofiXwGZ.png alt="200 response for the token introspective">
This is still very basic and just a function. I need to make this in a Middle ware that every service use will use. I will have also have to update my Saga Pattern works to internal services to pass this along, and find to add this into the Kafka implementation of the Saga Pattern even tho no services use it currently</p><h2 id=missing-token-features><del>Missing token features</del></h2><p><del>I am still having an issues with another feature of the token and that is local token verification since the token was created with a key with public SSO client I am not positive how how to get the key to work( I think there is still some gaps in my knowledge</del></p><p>Looking it at again when writing this I figured it out. It was something really dumb. (god this feelz good)</p><p>It was cause I did not add this shit to the start and finish to the public RSA key. God this was stupid. I just assumed this was remove&mldr;</p><blockquote><p>&ldquo;&mdash;&ndash;BEGIN CERTIFICATE&mdash;&ndash;\n
&mldr;.
&ldquo;\n&mdash;&ndash;END CERTIFICATE&mdash;&ndash;&rdquo;</p></blockquote><p>Okay know I can check locally on the token sent is legit, but not still valid cause if the user logs out before this expires.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>localJWTVerification</span>(accessToken *<span style=color:#6ab825;font-weight:700>string</span>) <span style=color:#6ab825;font-weight:700>error</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#999;font-style:italic>//log.Printf(&#34;TokenString: %#v&#34;, *accessToken)  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  
</span></span><span style=display:flex><span>  RSASampleSecret := <span style=color:#ed9d13>&#34;-----BEGIN CERTIFICATE-----\n&#34;</span> + <span style=color:#ed9d13>&#34;MII[REDACTED]AB&#34;</span> + <span style=color:#ed9d13>&#34;\n-----END CERTIFICATE-----&#34;</span>  
</span></span><span style=display:flex><span>  key, er := jwt.<span style=color:#447fcf>ParseRSAPublicKeyFromPEM</span>([]<span style=color:#24909d>byte</span>(RSASampleSecret))  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>if</span> er != <span style=color:#6ab825;font-weight:700>nil</span> {  
</span></span><span style=display:flex><span>      fmt.<span style=color:#447fcf>Println</span>(er)  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>   token, err := jwt.<span style=color:#447fcf>Parse</span>(*accessToken, <span style=color:#6ab825;font-weight:700>func</span>(token *jwt.Token) (<span style=color:#6ab825;font-weight:700>interface</span>{}, <span style=color:#6ab825;font-weight:700>error</span>) {  
</span></span><span style=display:flex><span>      <span style=color:#999;font-style:italic>// Don&#39;t forget to validate the alg is what you expect:  
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span>  <span style=color:#6ab825;font-weight:700>if</span> _, ok := token.Method.(*jwt.SigningMethodRSA); !ok {  
</span></span><span style=display:flex><span>         <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>, fmt.<span style=color:#447fcf>Errorf</span>(<span style=color:#ed9d13>&#34;Unexpected signing method: %v&#34;</span>, token.Header[<span style=color:#ed9d13>&#34;alg&#34;</span>])  
</span></span><span style=display:flex><span>      }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> key, <span style=color:#6ab825;font-weight:700>nil</span>  
</span></span><span style=display:flex><span>  })  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#6ab825;font-weight:700>if</span> token.Valid {  
</span></span><span style=display:flex><span>      fmt.<span style=color:#447fcf>Println</span>(<span style=color:#ed9d13>&#34;Token is valid!!!!&#34;</span>)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> <span style=color:#6ab825;font-weight:700>nil</span>  
</span></span><span style=display:flex><span>  } <span style=color:#6ab825;font-weight:700>else</span> <span style=color:#6ab825;font-weight:700>if</span> errors.<span style=color:#447fcf>Is</span>(err, jwt.ErrTokenMalformed) {  
</span></span><span style=display:flex><span>      fmt.<span style=color:#447fcf>Println</span>(<span style=color:#ed9d13>&#34;That&#39;s not even a token&#34;</span>)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> ErrLocalTokenValidationFailed  
</span></span><span style=display:flex><span>   } <span style=color:#6ab825;font-weight:700>else</span> <span style=color:#6ab825;font-weight:700>if</span> errors.<span style=color:#447fcf>Is</span>(err, jwt.ErrTokenExpired) || errors.<span style=color:#447fcf>Is</span>(err, jwt.ErrTokenNotValidYet) {  
</span></span><span style=display:flex><span>      fmt.<span style=color:#447fcf>Println</span>(<span style=color:#ed9d13>&#34;Timing is everything&#34;</span>)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> ErrLocalTokenValidationFailed  
</span></span><span style=display:flex><span>   } <span style=color:#6ab825;font-weight:700>else</span> {  
</span></span><span style=display:flex><span>      fmt.<span style=color:#447fcf>Println</span>(<span style=color:#ed9d13>&#34;Couldn&#39;t handle this token:&#34;</span>, err)  
</span></span><span style=display:flex><span>      <span style=color:#6ab825;font-weight:700>return</span> ErrLocalTokenValidationFailed  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=now-what>Now What.</h2><p>I am glad of what I have done it been a pain just being stuck for days on dumb things with a 100 tabs open.</p><p>Now I need to data map the user itself, intergrate it in the other services. figure out how to deal with new user and what to do with the user when they login. Plan a system of sending data to and frow rust and go.</p><p><em>Forward&mldr;</em></p></div></div></div></body><footer><hr>Author <a href=https://ed-m.dev/about>Edward M- </a>| Framework <a href=https://gohugo.io/>Hugo</a></footer></html>